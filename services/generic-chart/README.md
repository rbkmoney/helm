# Generic application

"Универсальный" helm-chart для приложений rbkmoney.

Поднимает собственно само приложение, будет настраивать мониторинг и сбор логов.

## Конфигурация

Пример минимального описания сервиса:

```yaml
app:
  team: devops

ingresses:
- host: "www.rbk.ru"
  paths:
  - /devops

resources:
  cpu: 200m
  memory: 256Mi
```

Доступны следующие настройки для конфигурации сервиса:

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| global.image.repository | Полное имя докер-образа приложения | `""` |
| global.image.tag | Репозиторий, в котором находится docker-image | `latest` |
| global.image.pullPolicy | Политика скачивания образа. Доступные параметры: `IfNotPresent`, `Always` | `IfNotPresent` |
| global.imagePullSecrets | Список секретов, которые необходимы в данном под для выкачивания образов | `[]` |
| replicaCount | Количество реплик приложения | `2` |
| app.port | Порт, на котором слушает приложение | `80` |
| app.env | Список переменных окружения, которые необходимы для работы приложения | `[]` |
| app.team | Команда, которая ответственна за приложение. По этому параметру определяется как собирать логи и метрики | Не указано, требуется указать явно |
| app.metrics.enabled | Нужен ли сбор метрик | `true` |
| app.metrics.path | Путь, по которому приложение отдает метрики в Prometheus-формате | `/internal/metrics` |
| app.metrics.interval | Как часто нужно собирать метрики | `15s` |
| app.logs.json | В каком формате приложение пишет логи, json или нет | `true` |
| app.probes.livenessPath | Ручка для liveness-проверок (живо ли вообще приложение) | `/internal/ping` |
| app.probes.readinessPath | Ручка для readiness-проверок (готово ли приложение принимать трафик) | `/internal/ping` |
| app.probes.initialDelaySeconds | Время до начала проверок | `10` |
| app.probes.periodSeconds | Как часто делать проверки | `5` |
| app.probes.failureThreshold | Количество проверок, после которых сервис считается нездоровым | `3` |
| app.additionalAnnotations | Дополнительные аннотации. С помощью них можно, например, настраивать парсинг логи | `{}` |
| initContainers | Описание init-контейнеров, если они нужны. [Более подробно](#initContainers) | `[]` |
| hooks | Описание джоб-хуков, если они нужны. [Более подробно](#hooks) | `[]` |
| service.type | Тип сервиса в Kubernetes | `ClusterIP` |
| service.port | Порт, по которому Kubernetes-сервис будет доступен | `80` |
| ingresses | Список необходимых сервису ингрессов. [Более подробно](#ingresses) | `[]` |
| resources.cpu | Количество CPU, которое необходимо сервису. Следует указывать с небольшим запасом от среднего потребления сервиса | Не указано, требуется указать явно |
| resources.memory | Количество оперативной памяти, которое необходимо сервису и которым оно будет ограниченно | Не указано, требуется указать явно |
| linkerd.enabled | Нужно ли добавлять sidecar-контейнер c Linkerd | `true` |
| redis.temp | Нужен ли сервису redis, который будет поднят внутри Kubernetes. Следует использовать только для stage-окружений | `false` |
| redis.azure | **DEPRECATED** *Используйте переменные окружения и подстановку значений из Vault* Нужен ли сервису redis, который будет поднят в Azure | `false` |
| azureRedis.uri | Строка для подключения к редис. Передается в переменную окружения `REDIS` только если `redis.azure` выставлено в `true` | `""`  |
| cronjobs | Описание кронджоб. [Более подробно](../cronjobs) | `{}` |
| stunnel | Описание тунелей. [Более подробно](../stunnel) | `{}` |

### initContainers

Пример описания init-контейнера:

```yaml
- name: init
  # объект image может быть не указан
  # в таком случае будет взят тот же образ, что и для основного приложения
  image:
    repository: image-name
    tag: image-tag
  command:
  - npm
  - run
  - something
  env:
  - name: ENV_VAR_NAME
    value: "env-var-value"
```

**Доступные параметры**:

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| name | Имя init-контейнера | `""` |
| image.repository | Полное имя докер-образа приложения | `""` |
| image.tag | Репозиторий, в котором находится docker-image | `""` |
| command | Команда, которую необходимо запустить при инициализации | `[]` |
| env | Переменные окружения | `[]` |

### hooks

Более подробно о хуках можно почитать [здесь](https://helm.sh/docs/topics/charts_hooks/).

Пример описания:

```yaml
- name: migrations
  # объект image может быть не указан
  # в таком случае будет взят тот же образ, что и для основного приложения
  image:
    repository: image-name
    tag: image-tag
  command:
  - npm
  - run
  - migrations
  env:
  - name: ENV_VAR_NAME
    value: "env-var-value"
```

**Доступные параметры**:

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| name | Имя хука | `""` |
| image.repository | Полное имя докер-образа приложения. Если не указано, то будет тот же образ, что и для основного приложения | `""` |
| image.tag | Репозиторий, в котором находится docker-image. Если не указано, то будет тот же образ, что и для основного приложения | `""` |
| stage | Этап, на котором будет запущен хук. [Список доступных этапов](https://helm.sh/docs/topics/charts_hooks/#the-available-hooks) | `"pre-install,pre-upgrade"` |
| weight | Вес, для определения порядка запуска хуков | `"1"` |
| deletePolicy | Определяет, когда нужно удалять старую джобу. [Доступные опции](https://helm.sh/docs/topics/charts_hooks/#hook-deletion-policies) | `"hook-succeeded,before-hook-creation"` |
| command | Команда, которую необходимо запустить при инициализации | `[]` |
| env | Переменные окружения | `[]` |

### ingresses

Можно указывать пути с регулярными выражениями. В целом с этим стоит быть аккуратнее.
[Вот](https://kubernetes.github.io/ingress-nginx/user-guide/ingress-path-matching/) в каком порядке отрабатываются пути.

Пример описания:
```yaml
- host: www.rbkmoney.ru
  # отключаем например для stage-окружения
  ssl: disabled
  additionalAnnotations:
    # этот набор аннотаций нужен для включения Basic-авторизации
    nginx.ingress.kubernetes.io/auth-type: "basic"
    nginx.ingress.kubernetes.io/auth-secret: "auth-secret"
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
  paths:
  - /nowhere
  - /$
```
**Доступные параметры**:

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| host | Доменное имя, по которому будет доступно приложение | |
| name | Имя для данного ингресса. Может быть не указано, если это единственный ингресс с таким доменным именем для данного сервиса | |
| ssl | Параметр для выключения ssl. По умолчанию, включен. Для выключения необходимо выставить значение в `disabled` | `enabled` |
| paths | Список необходимых путей |  |
| additionalAnnotations | Дополнительные аннотации для ингресса | `{}` |
| split | Нужен в случае, если какой-то раздел текущего сервиса переносят в другой | `false` |
| canary.weight | Процент, на который нужно отправлять трафик по данному правилу | |
| canary.cookie | Cookie, при которой нужно отправлять трафик в данное правило. Cookie должна иметь значение `always` или `never`. В остальных случаях будет игнорироваться | |

> ⚠️ Нельзя указывать mainstream и cookie правила в одном и том же yaml-файле. Для canary нужен отдельный бэкенд, для этого используются отдельные yaml-файлы с постфиксом `-canary`. Выкатываются они тоже отдельной кнопкой. Только если у вас все правила canary, то можно указать в основном yaml-файле.
