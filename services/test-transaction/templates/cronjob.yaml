apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{ include "test-transaction.fullname" . }}
  labels:
    {{- include "test-transaction.labels" . | nindent 4 }}
spec:
  schedule: "{{ .Values.schedule }}"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "test-transaction.labels" . | nindent 12 }}
        spec:
          {{- with .Values.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          serviceAccountName: {{ include "test-transaction.serviceAccountName" . }}
          containers:
            - name: gateway
              image: nginx
              ports:
                - name: api
                  containerPort: 80
                  protocol: TCP
              volumeMounts:
                - name: config-volume
                  mountPath: /etc/nginx/nginx.conf
                  subPath: nginx.conf
                  readOnly: true
                - name: config-volume
                  mountPath: /etc/nginx/virtualhost/virtualhost.conf
                  subPath: virtualhost.conf
                  readOnly: true
            - name: test-transaction
              image: "{{ .Values.image.repository }}:{{ .Chart.AppVersion }}"
              volumeMounts:
                - name: config-volume
                  mountPath: /opt/test-transaction/test-transaction.sh
                  subPath: test-transaction.sh
                  readOnly: true
              args:
                - "{{ .Values.keycloakUrl }}"
                - "{{ .Values.userName }}"
                - "{{ .Values.userPassword }}"
                - "{{ .Values.apiUrl }}"
                {{- if .Values.useIPv4 }}
                - "-4"
                {{- end }}
                {{- if .Values.createTestShop }}
                - --create-test-shop
                {{- end }}
          volumes:
            - name: config-volume
              configMap:
                name: {{ include "test-transaction.fullname" . }}
                items:
                - key: nginx.conf
                  path: nginx.conf
                - key: virtualhost.conf
                  path: virtualhost.conf
          restartPolicy: OnFailure
